<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Schedule Tracker</title>
  
  <!-- Theme Colors for Mobile -->
  <meta name="theme-color" content="#1976D2">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/keek/32/airplane-take-off.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://img.icons8.com/keek/96/airplane-take-off.png">
  <link rel="icon" type="image/png" sizes="100x100" href="https://img.icons8.com/keek/100/airplane-take-off.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/keek/180/airplane-take-off.png">
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
      padding-top: 80px; /* Space for fixed header */
    }

    /* Header - Fixed */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 16px;
      z-index: 100;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-title h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Last Update Section */
    .last-update {
      background: #E3F2FD;
      color: #1565C0;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .last-update-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .last-update-icon {
      color: #1976D2;
    }

    .update-badge {
      background: #1976D2;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pulse {
      width: 6px;
      height: 6px;
      background: #4CAF50;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Section */
    .section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      color: #2196F3;
    }

    .section-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #263238;
    }

    /* Form Group */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #546E7A;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      border: 1px solid #CFD8DC;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background: #FAFAFA;
      position: relative;
    }

    .input-wrapper {
      position: relative;
    }

    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #90A4AE;
      pointer-events: none;
    }

    .form-input:focus {
      outline: none;
      border-color: #2196F3;
      background: white;
    }

    .form-input::placeholder {
      color: #B0BEC5;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.2s;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 13px;
      color: #546E7A;
      font-weight: 500;
    }

    .stat-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon.blue {
      background: #E3F2FD;
      color: #2196F3;
    }

    .stat-icon.green {
      background: #E8F5E9;
      color: #4CAF50;
    }

    .stat-icon.orange {
      background: #FFF3E0;
      color: #FF9800;
    }

    .stat-icon.purple {
      background: #F3E5F5;
      color: #9C27B0;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #263238;
      margin-bottom: 4px;
    }

    .stat-subtitle {
      font-size: 12px;
      color: #90A4AE;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Gantt Chart */
    .gantt-chart-container {
      background: #FAFAFA;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      overflow-x: auto;
    }

    .gantt-chart {
      min-width: 1200px;
      position: relative;
    }

    /* Time Axis (X-axis) */
    .time-axis {
      display: flex;
      border-bottom: 2px solid #CFD8DC;
      margin-bottom: 10px;
      padding-bottom: 10px;
      margin-left: 150px;
    }

    .time-tick {
      flex: 1;
      text-align: center;
      font-size: 11px;
      color: #78909C;
      font-weight: 500;
      position: relative;
    }

    .time-tick::before {
      content: '';
      position: absolute;
      left: 0;
      top: -5px;
      width: 1px;
      height: 5px;
      background: #CFD8DC;
    }

    /* Chart Content */
    .chart-content {
      position: relative;
    }

    .flight-row {
      display: flex;
      align-items: center;
      height: 50px;
      border-bottom: 1px solid #ECEFF1;
      position: relative;
    }

    .flight-row:last-child {
      border-bottom: none;
    }

    .flight-label {
      width: 150px;
      padding-right: 20px;
      font-weight: 600;
      color: #263238;
      font-size: 14px;
      flex-shrink: 0;
    }

    .flight-timeline {
      flex: 1;
      position: relative;
      height: 40px;
      display: flex;
    }

    /* Grid lines for every 30 minutes */
    .grid-lines {
      position: absolute;
      top: 0;
      left: 150px;
      right: 0;
      bottom: 0;
      display: flex;
      pointer-events: none;
    }

    .grid-line {
      flex: 1;
      border-left: 1px solid #ECEFF1;
    }

    .grid-line:first-child {
      border-left: 2px solid #CFD8DC;
    }

    /* Flight bar */
    .flight-bar {
      position: absolute;
      height: 32px;
      top: 4px;
      background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
      cursor: pointer;
      transition: all 0.2s;
    }

    .flight-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.6);
      z-index: 10;
    }

    .flight-bar.overnight {
      background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
    }

    .flight-bar.overnight:hover {
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.6);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #78909C;
    }

    .spinner {
      border: 3px solid #E3F2FD;
      border-top: 3px solid #2196F3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #FFEBEE;
      color: #C62828;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #78909C;
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      color: #B0BEC5;
    }

    /* Legend */
    .chart-legend {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ECEFF1;
      font-size: 13px;
      color: #546E7A;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 8px;
      border-radius: 2px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding-top: 70px;
      }

      .container {
        padding: 16px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-value {
        font-size: 24px;
      }

      .header {
        padding: 16px 20px;
      }

      .header-title h1 {
        font-size: 18px;
      }

      .flight-label {
        width: 100px;
        font-size: 12px;
      }

      .time-tick {
        font-size: 9px;
      }

      .gantt-chart {
        min-width: 900px;
      }

      .last-update {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    /* Current time indicator */
    .current-time-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #f44336;
      z-index: 5;
      pointer-events: none;
    }

    .current-time-label {
      position: absolute;
      top: -20px;
      left: -20px;
      background: #f44336;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Modal for flight details */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #E3F2FD;
    }

    .modal-title {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #2196F3;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #F5F5F5;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: #78909C;
    }

    .modal-close:hover {
      background: #E3F2FD;
      color: #2196F3;
    }

    .modal-body {
      padding: 10px 0;
    }

    .modal-info-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      margin-bottom: 10px;
      background: #FAFAFA;
      border-radius: 8px;
    }

    .modal-info-icon {
      width: 40px;
      height: 40px;
      background: #E3F2FD;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2196F3;
    }

    .modal-info-content {
      flex: 1;
    }

    .modal-info-label {
      font-size: 12px;
      color: #78909C;
      margin-bottom: 4px;
    }

    .modal-info-value {
      font-size: 18px;
      font-weight: 600;
      color: #263238;
    }

    .overnight-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #FFF3E0;
      color: #F57C00;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-icon">
      <i data-lucide="plane" stroke-width="2"></i>
    </div>
    <div class="header-title">
      <h1>Flight Schedule Tracker</h1>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Last Update Section -->
    <div class="last-update">
      <div class="last-update-content">
        <i data-lucide="clock" size="18" class="last-update-icon"></i>
        <span>อัปเดตล่าสุด: <strong id="lastUpdateTime">กำลังโหลด...</strong></span>
      </div>
      <div class="update-badge">
        <div class="pulse"></div>
        <span id="countdownText">กำลังคำนวณ...</span>
      </div>
    </div>

    <!-- Search Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">
          <i data-lucide="search" stroke-width="2" size="18"></i>
        </div>
        <h2 class="section-title">ค้นหาเที่ยวบิน</h2>
      </div>

      <div class="form-group">
        <label class="form-label">
          <i data-lucide="plane-takeoff" size="16"></i>
          <span>หมายเลขเที่ยวบิน, เวลา</span>
        </label>
        <div class="input-wrapper">
          <i data-lucide="search" size="18" class="input-icon"></i>
          <input 
            type="text" 
            class="form-input" 
            id="searchInput"
            placeholder="เช่น DD300, 06:00"
            onkeyup="handleSearch()"
          >
        </div>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">
          <i data-lucide="bar-chart-3" stroke-width="2" size="18"></i>
        </div>
        <h2 class="section-title">สถิติการบิน</h2>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-label">ทั้งหมด</span>
            <div class="stat-icon blue">
              <i data-lucide="layers" size="18"></i>
            </div>
          </div>
          <div class="stat-value" id="totalFlights">-</div>
          <div class="stat-subtitle">
            <i data-lucide="plane" size="14"></i>
            <span>เที่ยวบิน</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-label">กำลัง operate</span>
            <div class="stat-icon green">
              <i data-lucide="radio" size="18"></i>
            </div>
          </div>
          <div class="stat-value" id="activeFlights">-</div>
          <div class="stat-subtitle">
            <i data-lucide="clock" size="14"></i>
            <span>ขณะนี้</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-label">เสร็จสิ้น</span>
            <div class="stat-icon orange">
              <i data-lucide="check-circle" size="18"></i>
            </div>
          </div>
          <div class="stat-value" id="completedFlights">-</div>
          <div class="stat-subtitle">
            <i data-lucide="plane-landing" size="14"></i>
            <span>เที่ยวบิน</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-label">เครื่องบินกำลังจะออก</span>
            <div class="stat-icon purple">
              <i data-lucide="clock-3" size="18"></i>
            </div>
          </div>
          <div class="stat-value" id="upcomingFlights">-</div>
          <div class="stat-subtitle">
            <i data-lucide="calendar" size="14"></i>
            <span>เที่ยวบิน</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Gantt Chart Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">
          <i data-lucide="gantt-chart" stroke-width="2" size="18"></i>
        </div>
        <h2 class="section-title">Gantt Chart - ตารางเที่ยวบิน</h2>
      </div>

      <div id="loadingContainer" class="loading">
        <div class="spinner"></div>
        <p>กำลังโหลดข้อมูล...</p>
      </div>

      <div id="errorContainer" style="display: none;"></div>

      <div id="ganttChartContainer" class="gantt-chart-container" style="display: none;">
        <!-- Gantt chart will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Modal for flight details -->
  <div class="modal-overlay" id="flightModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <i data-lucide="plane" size="24"></i>
          <span id="modalFlightNumber">-</span>
        </div>
        <button class="modal-close" onclick="closeModal()">
          <i data-lucide="x" size="20"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-info-row">
          <div class="modal-info-icon">
            <i data-lucide="plane-landing" size="20"></i>
          </div>
          <div class="modal-info-content">
            <div class="modal-info-label">เวลาเปิดเช็คอิน</div>
            <div class="modal-info-value" id="modalArrivalTime">-</div>
            <div id="modalOvernightBadge" style="display: none;"></div>
          </div>
        </div>
        <div class="modal-info-row">
          <div class="modal-info-icon">
            <i data-lucide="plane-takeoff" size="20"></i>
          </div>
          <div class="modal-info-content">
            <div class="modal-info-label">เวลาออกเดินทาง (เครื่องออก)</div>
            <div class="modal-info-value" id="modalDepartureTime">-</div>
          </div>
        </div>
        <div class="modal-info-row">
          <div class="modal-info-icon">
            <i data-lucide="timer" size="20"></i>
          </div>
          <div class="modal-info-content">
            <div class="modal-info-label">ระยะเวลาการบิน</div>
            <div class="modal-info-value" id="modalDuration">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ⚠️ แก้ไข API_URL ให้เป็น URL ที่ได้จาก Google Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbzBmlb05hqoRJdNnQVkQyX-DMr7grrNQUhtCKljqeU52tH1wjpzUWV2edrRBSNWuvt3/exec';
    
    let allFlights = [];
    let updateInterval;
    let countdownInterval;
    let lastUpdateTime = null;

    // Calculate next update time (next 10-minute mark)
    function getNextUpdateTime() {
      const now = new Date();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      
      // Calculate how many minutes until next 10-minute mark
      const minutesToNext = 10 - (minutes % 10);
      
      const nextUpdate = new Date(now);
      nextUpdate.setMinutes(minutes + minutesToNext);
      nextUpdate.setSeconds(0);
      nextUpdate.setMilliseconds(0);
      
      return nextUpdate;
    }

    // Update countdown display
    function updateCountdown() {
      const now = new Date();
      const nextUpdate = getNextUpdateTime();
      const diff = nextUpdate - now;
      
      const minutesLeft = Math.floor(diff / 60000);
      const secondsLeft = Math.floor((diff % 60000) / 1000);
      
      const countdownText = document.getElementById('countdownText');
      if (minutesLeft > 0) {
        countdownText.textContent = `อัปเดตใน ${minutesLeft} นาที ${secondsLeft} วินาที`;
      } else {
        countdownText.textContent = `อัปเดตใน ${secondsLeft} วินาที`;
      }
      
      // If countdown reaches 0, reload data
      if (diff <= 0) {
        loadData();
      }
    }

    // Start countdown timer
    function startCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    // Calculate statistics from flights data with 15-minute buffer for upcoming
    function calculateStatistics(flights) {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      
      let total = flights.length;
      let active = 0;
      let completed = 0;
      let upcoming = 0;
      
      flights.forEach(flight => {
        const startMin = timeToMinutes(flight.start); // Arrival time
        let endMin = timeToMinutes(flight.end); // Departure time
        
        // Handle overnight flights
        const isOvernight = endMin < startMin;
        if (isOvernight) {
          endMin += 1440;
        }
        
        // Adjust current time for overnight comparison
        let adjustedCurrentMin = currentMinutes;
        if (startMin > 1200 && currentMinutes < 240) { // If flight starts late and current time is early morning
          adjustedCurrentMin += 1440;
        }
        
        // 15 minutes before departure time
        const departureBufferStart = endMin - 15;
        
        // Determine flight status
        if (adjustedCurrentMin < startMin) {
          // Before arrival - not counted in any category
        } else if (adjustedCurrentMin >= startMin && adjustedCurrentMin < departureBufferStart) {
          active++; // Operating (between arrival and 15 min before departure)
        } else if (adjustedCurrentMin >= departureBufferStart && adjustedCurrentMin <= endMin) {
          upcoming++; // About to depart (15 min before departure until departure time, inclusive)
        } else if (adjustedCurrentMin > endMin) {
          completed++; // Already departed
        }
      });
      
      return { total, active, completed, upcoming };
    }

    // Initialize app
    window.onload = function() {
      loadData();
      startAutoUpdate();
      startCountdown();
      lucide.createIcons();
    };

    // Update last update time display
    function updateLastUpdateDisplay() {
      if (lastUpdateTime) {
        const options = { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        };
        const formattedTime = lastUpdateTime.toLocaleString('th-TH', options);
        document.getElementById('lastUpdateTime').textContent = formattedTime;
      }
    }

    // Load data from API
    async function loadData() {
      try {
        // Get flights data
        const flightsResponse = await fetch(`${API_URL}?action=getFlights`);
        const flightsData = await flightsResponse.json();

        if (!flightsData.success) {
          throw new Error(flightsData.error);
        }

        allFlights = flightsData.data;
        lastUpdateTime = new Date();
        updateLastUpdateDisplay();
        startCountdown(); // Restart countdown after update

        // Calculate statistics on client side
        const stats = calculateStatistics(allFlights);
        updateStatistics(stats);

        displayGanttChart(allFlights);
        
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('errorContainer').style.display = 'none';
        document.getElementById('ganttChartContainer').style.display = 'block';

      } catch (error) {
        handleError(error.message);
      }
    }

    // Update statistics display
    function updateStatistics(stats) {
      document.getElementById('totalFlights').textContent = stats.total;
      document.getElementById('activeFlights').textContent = stats.active;
      document.getElementById('completedFlights').textContent = stats.completed;
      document.getElementById('upcomingFlights').textContent = stats.upcoming;
    }

    // Check if flight is overnight (crosses midnight)
    function isOvernightFlight(startTime, endTime) {
      const startMin = timeToMinutes(startTime);
      const endMin = timeToMinutes(endTime);
      return endMin < startMin;
    }

    // Display Gantt Chart
    function displayGanttChart(flights) {
      const container = document.getElementById('ganttChartContainer');
      
      if (flights.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <i data-lucide="inbox" size="80"></i>
            </div>
            <h3 style="margin-bottom: 8px; color: #546E7A;">ไม่พบข้อมูลเที่ยวบิน</h3>
            <p>ลองค้นหาด้วยคำอื่นหรือรีเฟรชหน้าเว็บ</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      // Generate time axis (00.00 - 24.00, every 3 hours)
      const timeLabels = [];
      for (let hour = 0; hour <= 24; hour += 3) {
        const timeStr = `${hour.toString().padStart(2, '0')}.00`;
        timeLabels.push(timeStr);
      }

      // Create time axis HTML
      const timeAxisHTML = timeLabels.map(time => 
        `<div class="time-tick">${time}</div>`
      ).join('');

      // Create grid lines
      const gridLinesHTML = timeLabels.map(() => 
        `<div class="grid-line"></div>`
      ).join('');

      // Create flight rows
      const flightRowsHTML = flights.map((flight, index) => {
        const startMin = timeToMinutes(flight.start);
        const endMin = timeToMinutes(flight.end);
        const isOvernight = isOvernightFlight(flight.start, flight.end);
        
        let flightBarsHTML = '';
        
        if (isOvernight) {
          // Split into two bars: one from start to 24:00, another from 00:00 to end
          const leftPercent1 = (startMin / 1440) * 100;
          const widthPercent1 = ((1440 - startMin) / 1440) * 100; // Till midnight
          
          const leftPercent2 = 0;
          const widthPercent2 = (endMin / 1440) * 100; // From midnight
          
          flightBarsHTML = `
            <div class="flight-bar overnight" 
                 style="left: ${leftPercent1}%; width: ${widthPercent1}%;"
                 onclick='showFlightDetails(${JSON.stringify(flight)})'>
            </div>
            <div class="flight-bar overnight" 
                 style="left: ${leftPercent2}%; width: ${widthPercent2}%;"
                 onclick='showFlightDetails(${JSON.stringify(flight)})'>
            </div>
          `;
        } else {
          // Normal single bar
          const leftPercent = (startMin / 1440) * 100;
          const widthPercent = ((endMin - startMin) / 1440) * 100;
          
          flightBarsHTML = `
            <div class="flight-bar" 
                 style="left: ${leftPercent}%; width: ${widthPercent}%;"
                 onclick='showFlightDetails(${JSON.stringify(flight)})'>
            </div>
          `;
        }

        return `
          <div class="flight-row">
            <div class="flight-label">${flight.flight}</div>
            <div class="flight-timeline">
              ${flightBarsHTML}
            </div>
          </div>
        `;
      }).join('');

      // Get current time position
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const currentTimePercent = (currentMinutes / 1440) * 100;
      const currentTimeStr = `${now.getHours().toString().padStart(2, '0')}.${now.getMinutes().toString().padStart(2, '0')}`;

      // Assemble chart
      container.innerHTML = `
        <div class="gantt-chart">
          <div class="time-axis">${timeAxisHTML}</div>
          <div class="chart-content">
            <div class="grid-lines">${gridLinesHTML}</div>
            ${flightRowsHTML}
            <div class="current-time-line" style="left: calc(150px + (100% - 150px) * ${currentTimePercent / 100})">
              <div class="current-time-label">ขณะนี้ ${currentTimeStr}</div>
            </div>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color" style="background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);"></div>
              <span>เที่ยวบินปกติ</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);"></div>
              <span>เที่ยวบินข้ามวัน</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f44336; height: 2px;"></div>
              <span>เวลาปัจจุบัน</span>
            </div>
          </div>
        </div>
      `;

      lucide.createIcons();
    }

    // Calculate duration text
    function calculateDuration(start, end) {
      const startMin = timeToMinutes(start);
      let endMin = timeToMinutes(end);
      
      // Handle overnight flights
      if (endMin < startMin) {
        endMin += 1440; // Add 24 hours
      }
      
      const duration = endMin - startMin;
      const hours = Math.floor(duration / 60);
      const minutes = duration % 60;
      return `${hours}ชม ${minutes}นาที`;
    }

    // Convert time to minutes
    function timeToMinutes(timeStr) {
      const parts = timeStr.toString().replace('.', ':').split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    // Format time with dots (00.00 instead of 00:00)
    function formatTimeWithDots(timeStr) {
      return timeStr.replace(':', '.');
    }

    // Show flight details modal
    function showFlightDetails(flight) {
      const isOvernight = isOvernightFlight(flight.start, flight.end);
      
      document.getElementById('modalFlightNumber').textContent = flight.flight;
      document.getElementById('modalArrivalTime').textContent = formatTimeWithDots(flight.start);
      document.getElementById('modalDepartureTime').textContent = formatTimeWithDots(flight.end);
      document.getElementById('modalDuration').textContent = calculateDuration(flight.start, flight.end);
      
      const overnightBadge = document.getElementById('modalOvernightBadge');
      if (isOvernight) {
        overnightBadge.style.display = 'block';
        overnightBadge.innerHTML = `
          <div class="overnight-badge">
            <i data-lucide="moon" size="12"></i>
            <span>เที่ยวบินข้ามวัน</span>
          </div>
        `;
      } else {
        overnightBadge.style.display = 'none';
      }
      
      const modal = document.getElementById('flightModal');
      modal.classList.add('active');
      
      // Re-initialize icons in modal
      setTimeout(() => lucide.createIcons(), 0);
    }

    // Close modal
    function closeModal(event) {
      if (event && event.target !== event.currentTarget && !event.target.closest('.modal-close')) {
        return;
      }
      const modal = document.getElementById('flightModal');
      modal.classList.remove('active');
    }

    // Handle search
    function handleSearch() {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      
      if (query === '') {
        displayGanttChart(allFlights);
        return;
      }

      const filtered = allFlights.filter(flight => {
        return flight.flight.toLowerCase().includes(query) ||
               flight.start.includes(query) ||
               flight.end.includes(query);
      });

      displayGanttChart(filtered);
    }

    // Start auto-update (every 10 minutes at 10-minute marks)
    function startAutoUpdate() {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
      
      // Calculate time until next 10-minute mark
      const now = new Date();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      const milliseconds = now.getMilliseconds();
      
      const minutesToNext = 10 - (minutes % 10);
      const msUntilNext = (minutesToNext * 60 - seconds) * 1000 - milliseconds;
      
      // Set timeout for first update at next 10-minute mark
      setTimeout(() => {
        loadData();
        // Then update every 10 minutes
        updateInterval = setInterval(loadData, 10 * 60 * 1000);
      }, msUntilNext);
    }

    // Handle errors
    function handleError(errorMessage) {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('ganttChartContainer').style.display = 'none';
      
      const errorContainer = document.getElementById('errorContainer');
      errorContainer.style.display = 'block';
      errorContainer.innerHTML = `
        <div class="error">
          <i data-lucide="alert-circle" size="24"></i>
          <div>
            <strong>เกิดข้อผิดพลาด</strong><br>
            ${errorMessage}<br><br>
            <small>กรุณาตรวจสอบ API_URL และสิทธิ์การเข้าถึง</small>
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    // Cleanup on unload
    window.onbeforeunload = function() {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
    };
  </script>
</body>
</html>

